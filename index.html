<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Offline Spending Tracker</title>

  <!-- PWA Manifest (inline via data URL for single-file use) -->
  <link rel="manifest"
    href='data:application/json,{"name":"Spending Tracker","short_name":"Spending","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#2563eb","icons":[{"src":"data:image/png;base64,iVBORw0KGgo=","sizes":"192x192","type":"image/png"}]}'>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    /* ===== Global reset ===== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      /* hard stop for iOS horizontal scroll */
    }

    /* ===== Base layout ===== */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      background: #f8fafc;
    }

    h1 {
      font-size: 1.5rem;
    }

    /* ===== Cards ===== */
    .card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      /* prevents rogue iOS inputs */
    }

    /* ===== Forms ===== */
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.9rem;
    }

    input,
    select,
    button,
    textarea {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      padding: 8px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 1rem;
      background: #fff;
    }

    /* ===== Number input (remove iOS spin overflow) ===== */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* ===== Range slider (iOS fix) ===== */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      max-width: 100%;
      margin: 8px 0;
      padding: 0;
      background: transparent;
    }

    input[type="range"]::-webkit-slider-runnable-track {
      height: 4px;
      background: #cbd5e1;
      border-radius: 2px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 20px;
      width: 20px;
      background: #2563eb;
      border-radius: 50%;
      margin-top: -8px;
    }

    /* ===== Buttons ===== */
    button {
      background: #2563eb;
      color: white;
      border: none;
      margin-top: 12px;
    }

    /* ===== Totals ===== */
    .totals p {
      margin: 4px 0;
    }

    /* ===== Tables ===== */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 6px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.85rem;
      text-align: left;
    }

    th {
      font-weight: 600;
    }

    /* ===== Header ===== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    #darkToggle {
      width: auto;
      padding: 6px 10px;
      font-size: 1.1rem;
      border-radius: 8px;
      background: #e5e7eb;
      color: #111827;
    }

    /* ===== Dark Mode ===== */
    body.dark {
      background: #0f172a;
      color: #e5e7eb;
    }

    body.dark .card {
      background: #020617;
      box-shadow: none;
    }

    body.dark input,
    body.dark select,
    body.dark textarea {
      background: #020617;
      color: #e5e7eb;
      border-color: #334155;
    }

    body.dark input[type="range"]::-webkit-slider-runnable-track {
      background: #334155;
    }

    body.dark input[type="range"]::-webkit-slider-thumb {
      background: #38bdf8;
    }

    body.dark button {
      background: #38bdf8;
      color: #020617;
    }

    body.dark th,
    body.dark td {
      border-bottom-color: #334155;
    }

    body.dark #darkToggle {
      background: #020617;
      color: #e5e7eb;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>Spending Tracker</h1>
    <button id="darkToggle" aria-label="Toggle dark mode">ðŸŒ™</button>
  </div>


  <div class="card">
    <h2>Add Spending</h2>

    <label>Item Name</label>
    <input type="text" id="item-name" />

    <label>Amount</label>
    <input type="number" id="amount" step="0.01" />

    <label>Category</label>
    <select id="category">
      <option>Food</option>
      <option>Transportation</option>
      <option>Housing</option>
      <option>Entertainment</option>
      <option>Other</option>
    </select>

    <label>Priority (1 = Want, 10 = Need)</label>
    <input type="range" id="rank" min="1" max="10" value="5"
      oninput="document.getElementById('rankValue').textContent = this.value" />
    <div style="text-align:center;font-size:0.9rem">Value: <span id="rankValue">5</span></div>

    <button onclick="addSpending()">Save</button>
  </div>

  <div class="card totals">
    <h2>Totals</h2>
    <p id="today"></p>
    <p id="week"></p>
    <p id="month"></p>
  </div>

  <div class="card">
    <h2>Recent Entries</h2>
    <table id="list" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Date</th>
          <th>Name</th>
          <th>Amount</th>
          <th>Category</th>
          <th>Priority</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="exportData()">Export Data (CSV)</button>
  </div>

  <script>
    // Service Worker (inline via Blob)
    // if ('serviceWorker' in navigator) {
    //   const swCode = `self.addEventListener('install', e => self.skipWaiting());
    // self.addEventListener('fetch', e => e.respondWith(caches.open('app').then(c => c.match(e.request).then(r => r || fetch(e.request)))));`;
    //   const blob = new Blob([swCode], { type: 'text/javascript' });
    //   navigator.serviceWorker.register(URL.createObjectURL(blob));
    // }

    const DARK_KEY = 'dark-mode';
    const toggle = document.getElementById('darkToggle');

    function applyDarkMode(on) {
      document.body.classList.toggle('dark', on);
      toggle.textContent = on ? 'â˜€ï¸' : 'ðŸŒ™';
      localStorage.setItem(DARK_KEY, on ? '1' : '0');
    }

    // Load preference
    applyDarkMode(localStorage.getItem(DARK_KEY) === '1');

    // Toggle on click
    toggle.addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark');
      applyDarkMode(!isDark);
    });


    const STORAGE_KEY = 'spendings';

    function load() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    }

    function save(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function normalize(x) {
      return (x - 1) / (10 - 1);
    }

    function dailyScore() {
      const data = load();
      let total = 0;
      let acc = 0;
      data.forEach(e => {
        const d = new Date(e.date);
        const now = new Date();
        if (isSameDay(d, now)) {
          total += e.amount;
          acc += e.amount * normalize(e.rank);
        }
      });
      return acc / total * 100;
    }

    function weeklyScore() {
      const data = load();
      let total = 0;
      let acc = 0;
      data.forEach(e => {
        const d = new Date(e.date);
        const now = new Date();
        if (d >= new Date(now - 7 * 24 * 60 * 60 * 1000)) {
          total += e.amount;
          acc += e.amount * normalize(e.rank);
        }
      });
      return acc / total * 100;
    }

    function monthlyScore() {
      const data = load();
      let total = 0;
      let acc = 0;
      data.forEach(e => {
        const d = new Date(e.date);
        const now = new Date();
        if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
          total += e.amount;
          acc += e.amount * normalize(e.rank);
        }
      });
      return acc / total * 100;
    }

    function addSpending() {
      const name = document.getElementById('item-name').value;
      if (!name) return;
      const amount = parseFloat(document.getElementById('amount').value);
      if (!amount) return;

      const entry = {
        name,
        amount,
        category: document.getElementById('category').value,
        rank: parseInt(document.getElementById('rank').value),
        date: new Date().toISOString()
      };

      const data = load();
      data.push(entry);
      save(data);
      render();
    }

    function isSameDay(a, b) {
      return a.toDateString() === b.toDateString();
    }

    function render() {
      const data = load();
      const now = new Date();

      let today = 0, week = 0, month = 0;

      data.forEach(e => {
        const d = new Date(e.date);
        if (isSameDay(d, now)) today += e.amount;
        if (d >= new Date(now - 7 * 24 * 60 * 60 * 1000)) week += e.amount;
        if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) month += e.amount;
      });

      document.getElementById('today').textContent = `Today: L.E. ${today.toFixed(2)} - Score: ${dailyScore().toFixed(2)}%`;
      document.getElementById('week').textContent = `This Week: L.E. ${week.toFixed(2)} - Score: ${weeklyScore().toFixed(2)}%`;
      document.getElementById('month').textContent = `This Month: L.E. ${month.toFixed(2)} - Score: ${monthlyScore().toFixed(2)}%`;

      const table = document.getElementById('list').querySelector('tbody');
      table.innerHTML = '';

      data.slice(-10).reverse().forEach(e => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
    <td>${new Date(e.date).toLocaleString()}</td>
    <td>${e.name ?? ''}</td>
    <td>L.E. ${e.amount}</td>
    <td>${e.category}</td>
    <td>${e.rank}</td>
  `;

        table.appendChild(tr);
      });

    }

    render();

    function exportData() {
      const data = load();
      if (!data.length) return;

      const header = ['name', 'amount', 'category', 'priority', 'date'];
      const rows = data.map(e => [e.name, e.amount, e.category, e.rank, e.date]);
      const csv = [header, ...rows]
        .map(r => r.join(','))
        .join('');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'spending-data.csv';
      a.click();

      URL.revokeObjectURL(url);
    }
  </script>
</body>

</html>
